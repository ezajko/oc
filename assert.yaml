---
- hosts: sms
  gather_facts: yes
  vars:
    services:
      - chronyd
      - xcatd
      - ipa
      - dhcpd
    directories:
      - /tftpboot/xcat/xnba/nodes
  pre_tasks:
    - package_facts:
        manager: auto
  tasks:

  - name: Get trsuted interfaces
    shell: |
      firewall-cmd --list-all --zone=trusted | awk '/interfaces/ { print $2 }'
    register: zones

  - name: Internal interface should be in trusted zone
    assert:
      that:
        - "'{{ sms_eth_internal }}' in zones.stdout"

  - name: Check service
    shell: |
      systemctl is-active {{ service }}
    loop: '{{ services }}'
    loop_control:
      loop_var: service
    changed_when: false

  - name: Check directories
    loop: '{{ directories }}'
    shell: |
      test -d '{{ item }}'
    changed_when: false

  - name: nmcli should not have Wired connection 1 (it is enp2s0 (the device name))
    shell:
      nmcli c show | grep 'Wired connection'
    changed_when: false

  - name: Check that headnode hostname is present in /etc/hosts
    changed_when: false
    shell: |
      grep -E '^{{ sms_ip }}\s+{{ fqdn }}\s+{{ cluster_name }}' /etc/hosts

  - name: Check that first node is booted
    shell: /opt/xcat/bin/lsdef {{ 0 | node_name }} -i status | awk -F= '/status/ { print $2 }'
    changed_when: false
    register: lsdef
    failed_when: lsdef.rc != 0 and lsdef.stdout != "booted"

  - name: Connect to first node
    shell: |
      ssh {{ 0 | node_name }} -- echo okay
    changed_when: false

  - name: Check that chrony is installed and running on node
    shell: |
      ssh {{ 0 | node_name }} -- "rpm -q chrony; systemctl is-active chronyd"
    changed_when: false

  - name: Check that automount is working
    shell: |
      ssh {{ 0 | node_name }} -- "mount | grep 172.26.255.254:/opt/ohpc/pub"
    changed_when: false
