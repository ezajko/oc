---
- hosts: ovirtserver
  gather_facts: no
  vars:
    vm: ansible-test-node
    ovirt_host: ovirt2
  tasks:
    - assert:
        that:
          - lookup("env", "OVIRT_PASSWORD")

    - ovirt_vm:
        auth:
          insecure: yes
          url: https://ovirt.local.versatushpc.com.br/ovirt-engine/api
          username: admin@internal
          password: '{{ lookup("env", "OVIRT_PASSWORD") }}'
        name: "{{ vm }}"
        state: stopped
        force: yes
      delegate_to: localhost

    - ovirt_vm:
        auth:
          insecure: yes
          url: https://ovirt.local.versatushpc.com.br/ovirt-engine/api
          username: admin@internal
          password: '{{ lookup("env", "OVIRT_PASSWORD") }}'
        name: "{{ vm }}"
        state: running
        host: "{{ ovirt_host }}"
        force_migrate: yes
      delegate_to: localhost

