---
- hosts: ovirtserver
  gather_facts: no
  vars:
    vm: ansible-test
    ovirt_host: rhv2 
  tasks:
    - assert:
        that:
          - lookup("env", "OVIRT_PASSWORD")

    - ovirt_snapshot_facts:
        auth:
          insecure: yes
          url: https://ovirt.local.versatushpc.com.br/ovirt-engine/api
          username: admin@internal
          password: '{{ lookup("env", "OVIRT_PASSWORD") }}'
        vm: "{{ vm }}"
        description: before-ansible
      delegate_to: localhost

    - debug:
        var: ovirt_snapshots
      delegate_to: localhost

    - ovirt_vm:
        auth:
          insecure: yes
          url: https://ovirt.local.versatushpc.com.br/ovirt-engine/api
          username: admin@internal
          password: '{{ lookup("env", "OVIRT_PASSWORD") }}'
        name: "{{ vm }}"
        state: stopped
        force: yes
      delegate_to: localhost

    - ovirt_snapshot:
        vm_name: "{{ vm }}"
        auth:
          insecure: yes
          url: https://ovirt.local.versatushpc.com.br/ovirt-engine/api
          username: admin@internal
          password: '{{ lookup("env", "OVIRT_PASSWORD") }}'
        state: restore
        snapshot_id: '{{ ovirt_snapshots[0].id }}'
      delegate_to: localhost

    - ovirt_vm:
        auth:
          insecure: yes
          url: https://ovirt.local.versatushpc.com.br/ovirt-engine/api
          username: admin@internal
          password: '{{ lookup("env", "OVIRT_PASSWORD") }}'
        name: "{{ vm }}"
        state: running
        force_migrate: yes
        host: "{{ ovirt_host }}"
      delegate_to: localhost

